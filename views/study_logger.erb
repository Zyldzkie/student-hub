<% @title = 'Study Logger' %>
<div class="page-header">
    <div>
        <h1>Study Logger</h1>
        <p class="subtitle">Track your study sessions with a Pomodoro timer</p>
    </div>
</div>

<div class="study-session-card">
    <div class="session-header">
        <i class="fas fa-book-open session-icon"></i>
        <h2>Study Session</h2>
    </div>
    <p class="session-subtitle" id="session-subtitle">25-minute focus session</p>
    
    <div class="timer-controls-top">
        <div class="timer-duration-control">
            <label for="timer-duration">Duration (minutes):</label>
            <input type="number" id="timer-duration" min="1" max="120" step="1" value="25" onchange="updateTimerDuration()" oninput="validateIntegerInput(this)">
        </div>
    </div>
    
    <div class="subject-input-group">
        <label for="study-subject">What are you studying?</label>
        <input type="text" id="study-subject" placeholder="e.g., Mathematics, History">
    </div>
    
    <div class="timer-display">
        <div class="timer-time" id="timer-display">25:00</div>
    </div>
    
    <div class="progress-section">
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="progress-text" id="progress-text">0% complete</div>
    </div>
    
    <div class="timer-controls">
        <button class="btn-timer btn-start" id="start-btn" onclick="startTimer()">
            <span>▶</span> Start
        </button>
        <button class="btn-timer btn-reset" id="reset-btn" onclick="resetTimer()">
            <span>↻</span> Reset
        </button>
    </div>
    <div class="timer-controls" id="repeat-controls" style="display: none; margin-top: 12px;">
        <button class="btn-timer btn-repeat" id="repeat-btn" onclick="repeatLastSession()">
            <span>↻</span> Repeat Last Session
        </button>
    </div>
</div>

<div class="study-logger-bottom-layout">
    <div class="statistics-card">
        <h2>Statistics</h2>
        <p class="statistics-subtitle">Your study time summary</p>
        
        <div class="stat-item">
            <div class="stat-label">Today</div>
            <div class="stat-values">
                <span class="stat-value" id="today-minutes">0</span> <span class="stat-unit">min</span>
                <span class="stat-value" id="today-sessions">0</span> <span class="stat-unit">sessions</span>
            </div>
        </div>
        
        <div class="stat-item">
            <div class="stat-label">This Week</div>
            <div class="stat-values">
                <span class="stat-value" id="week-minutes">0</span> <span class="stat-unit">min</span>
                <span class="stat-value" id="week-sessions">0</span> <span class="stat-unit">sessions</span>
            </div>
        </div>
        
        <div class="stat-item">
            <div class="stat-label">Total Sessions</div>
            <div class="stat-values">
                <span class="stat-value" id="total-sessions">0</span>
            </div>
        </div>
    </div>
    
    <div class="recent-sessions-card">
        <h2>Recent Sessions</h2>
        <p class="recent-sessions-subtitle">Your latest study sessions</p>
        <div class="sessions-list" id="sessions-list">
            <p class="empty-state">No study sessions yet. Start your first session!</p>
        </div>
    </div>
</div>

<script>
    let timerInterval = null;
    let timerDuration = 25; // in minutes
    let timeRemaining = 25 * 60; // in seconds
    let isRunning = false;
    let lastSession = null;
    let allSessions = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadSessions();
        updateTimerDisplay();
    });

    function updateTimerDuration() {
        if (isRunning) return;
        timerDuration = parseInt(document.getElementById('timer-duration').value) || 25;
        timeRemaining = timerDuration * 60;
        updateTimerDisplay();
        updateSubtitle();
    }

    function updateSubtitle() {
        document.getElementById('session-subtitle').textContent = `${timerDuration}-minute focus session`;
    }

    function startTimer() {
        if (isRunning) {
            pauseTimer();
            return;
        }
        
        const subject = document.getElementById('study-subject').value.trim();
        if (!subject) {
            alert('Please enter what you are studying');
            return;
        }
        
        isRunning = true;
        document.getElementById('start-btn').innerHTML = '<span>⏸</span> Pause';
        document.getElementById('start-btn').classList.add('btn-pause');
        document.getElementById('study-subject').disabled = true;
        document.getElementById('timer-duration').disabled = true;
        
        timerInterval = setInterval(() => {
            if (timeRemaining > 0) {
                timeRemaining--;
                updateTimerDisplay();
                updateProgress();
            } else {
                completeSession();
            }
        }, 1000);
    }

    function pauseTimer() {
        isRunning = false;
        clearInterval(timerInterval);
        document.getElementById('start-btn').innerHTML = '<span>▶</span> Start';
        document.getElementById('start-btn').classList.remove('btn-pause');
    }

    function resetTimer() {
        isRunning = false;
        clearInterval(timerInterval);
        timeRemaining = timerDuration * 60;
        updateTimerDisplay();
        updateProgress();
        document.getElementById('start-btn').innerHTML = '<span>▶</span> Start';
        document.getElementById('start-btn').classList.remove('btn-pause');
        document.getElementById('study-subject').disabled = false;
        document.getElementById('timer-duration').disabled = false;
    }

    function completeSession() {
        isRunning = false;
        clearInterval(timerInterval);
        
        const subject = document.getElementById('study-subject').value.trim();
        const completedDuration = timerDuration; // Store before resetting
        const hours = timerDuration / 60;
        
        // Save session
        fetch('/api/study-sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                subject, 
                hours: hours,
                notes: null
            })
        })
        .then(res => res.json())
        .then(data => {
            // Store last session for repeat
            lastSession = {
                subject: subject,
                duration: completedDuration
            };
            document.getElementById('repeat-controls').style.display = 'flex';
            
            // Clear subject and reset duration to 25
            document.getElementById('study-subject').value = '';
            document.getElementById('timer-duration').value = 25;
            timerDuration = 25;
            timeRemaining = 25 * 60;
            updateTimerDisplay();
            updateSubtitle();
            updateProgress();
            
            resetTimer();
            loadSessions();
            
            // Show completion message
            alert(`Great job! You completed ${completedDuration} minutes of ${subject}!`);
        });
    }

    function repeatLastSession() {
        if (!lastSession) return;
        
        document.getElementById('study-subject').value = lastSession.subject;
        document.getElementById('timer-duration').value = lastSession.duration;
        updateTimerDuration();
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        document.getElementById('timer-display').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function updateProgress() {
        const totalSeconds = timerDuration * 60;
        const progress = ((totalSeconds - timeRemaining) / totalSeconds) * 100;
        document.getElementById('progress-bar').style.width = `${progress}%`;
        document.getElementById('progress-text').textContent = `${Math.round(progress)}% complete`;
    }

    function loadSessions() {
        fetch('/api/study-sessions')
            .then(res => res.json())
            .then(data => {
                allSessions = data.sessions;
                updateStatistics(data.sessions);
                renderSessions(data.sessions);
                
                // Set last session if available
                if (data.sessions.length > 0) {
                    const latest = data.sessions[0];
                    const duration = Math.round(parseFloat(latest.hours) * 60);
                    lastSession = {
                        subject: latest.subject,
                        duration: duration
                    };
                    document.getElementById('repeat-controls').style.display = 'flex';
                }
            });
    }

    function updateStatistics(sessions) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - now.getDay());
        weekStart.setHours(0, 0, 0, 0);
        
        let todayMinutes = 0;
        let todayCount = 0;
        let weekMinutes = 0;
        let weekCount = 0;
        
        sessions.forEach(session => {
            const sessionDate = new Date(session.date);
            const minutes = Math.round(parseFloat(session.hours) * 60);
            
            if (sessionDate >= today) {
                todayMinutes += minutes;
                todayCount++;
            }
            if (sessionDate >= weekStart) {
                weekMinutes += minutes;
                weekCount++;
            }
        });
        
        document.getElementById('today-minutes').textContent = todayMinutes;
        document.getElementById('today-sessions').textContent = todayCount;
        document.getElementById('week-minutes').textContent = weekMinutes;
        document.getElementById('week-sessions').textContent = weekCount;
        document.getElementById('total-sessions').textContent = sessions.length;
    }

    function renderSessions(sessions) {
        const container = document.getElementById('sessions-list');
        
        if (sessions.length === 0) {
            container.innerHTML = '<p class="empty-state">No study sessions yet. Start your first session!</p>';
            return;
        }
        
        // Sort by date (newest first) and limit to recent 10
        const sortedSessions = [...sessions]
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, 10);
        
        container.innerHTML = sortedSessions.map(session => {
            const minutes = Math.round(parseFloat(session.hours) * 60);
            const date = new Date(session.date);
            const formattedDate = date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            return `
                <div class="session-item">
                    <div class="session-icon-small"><i class="fas fa-book-open"></i></div>
                    <div class="session-content">
                        <div class="session-subject">${escapeHtml(session.subject)}</div>
                        <div class="session-meta">
                            <span class="session-duration">${minutes} min</span>
                            <span class="session-date">${formattedDate}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function validateIntegerInput(input) {
        // Only validate if timer is not running
        if (isRunning) {
            // Restore previous value if trying to change while running
            input.value = timerDuration;
            return;
        }
        
        // Remove any decimal points and non-numeric characters
        let value = input.value.replace(/[^\d]/g, '');
        
        // Convert to integer
        value = parseInt(value) || 1;
        
        // Ensure it's within valid range
        if (value < 1) value = 1;
        if (value > 120) value = 120;
        
        input.value = value;
        updateTimerDuration();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>

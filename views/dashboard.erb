<% @title = 'Dashboard' %>
<div class="page-header">
    <div>
        <h1>Dashboard</h1>
        <p class="subtitle">Welcome back! Here's your academic overview</p>
    </div>
</div>

<div class="dashboard-grid">
    <div class="dashboard-card">
        <h3>Overall GWA</h3>
        <p class="stat-value" id="overall-gwa">--</p>
        <p class="stat-label">Based on all subjects</p>
    </div>
    <div class="dashboard-card">
        <h3>Subjects</h3>
        <p class="stat-value" id="subjects-count">0</p>
        <p class="stat-label">Subjects this semester</p>
    </div>
    <div class="dashboard-card">
        <h3>Pending Tasks</h3>
        <p class="stat-value" id="pending-tasks">0</p>
        <p class="stat-label">Items in your to-do list</p>
    </div>
    <div class="dashboard-card">
        <h3>Study Hours</h3>
        <p class="stat-value" id="study-hours">0</p>
        <p class="stat-label">Hours logged this week</p>
    </div>
</div>

<div class="dashboard-section">
    <h2>Recent Activity</h2>
    <div class="activity-list" id="activity-list">
        <p class="empty-state">No recent activity</p>
    </div>
</div>

<div class="dashboard-section">
    <h2>Semester Profiles</h2>
    <p class="subtitle">Organize your academics by semester. You can use the Default profile or create specific semester profiles.</p>
    
    <div class="profile-controls">
        <button class="btn btn-primary" onclick="showCreateProfileModal()">
            <span>âž•</span> Create New Semester
        </button>
    </div>
    
    <div class="profiles-container" id="profiles-container">
        <p class="empty-state">Loading profiles...</p>
    </div>
</div>

<div class="dashboard-section">
    <h2>Profile Analytics</h2>
    <p class="subtitle">Compare your academic performance across different semesters</p>
    
    <div class="analytics-container" id="analytics-container">
        <p class="empty-state">Loading analytics...</p>
    </div>
</div>

<!-- Create Profile Modal -->
<div id="createProfileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Semester Profile</h3>
            <button class="close-btn" onclick="closeCreateProfileModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="profileName">Semester Name *</label>
                <input type="text" id="profileName" placeholder="e.g., 4th year 2nd Sem - 2025" required>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCreateProfileModal()">Cancel</button>
            <button class="btn btn-primary" onclick="createProfile()">Create Profile</button>
        </div>
    </div>
</div>

<script>
    let currentActiveProfileId = null;

    // Load dashboard data
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
        loadProfiles();
    });

    function loadDashboardData() {
        // Load GWA subjects
        fetch('/api/gwa-subjects')
            .then(res => res.json())
            .then(data => {
                document.getElementById('subjects-count').textContent = data.subjects.length;
                const gwaElement = document.getElementById('overall-gwa');
                if (data.gwa !== null && data.gwa !== undefined) {
                    gwaElement.textContent = data.gwa.toFixed(2);
                } else {
                    gwaElement.textContent = '--';
                }
            });

        // Load todos
        fetch('/api/todos')
            .then(res => res.json())
            .then(data => {
                const pending = data.todos.filter(t => !t.completed).length;
                document.getElementById('pending-tasks').textContent = pending;
            });

        // Load study sessions
        fetch('/api/study-sessions')
            .then(res => res.json())
            .then(data => {
                const thisWeek = getThisWeekHours(data.sessions);
                document.getElementById('study-hours').textContent = thisWeek.toFixed(1);
            });
    }
    
    // Profile Management Functions
    function loadProfiles() {
        fetch('/api/profiles')
            .then(res => res.json())
            .then(data => {
                currentActiveProfileId = data.active_profile_id;
                displayProfiles(data.profiles);
                loadAllAnalytics(data.profiles);
            });
    }
    
    function displayProfiles(profiles) {
        const container = document.getElementById('profiles-container');
        
        if (profiles.length === 0) {
            container.innerHTML = '<p class="empty-state">No profiles yet. Create one to get started!</p>';
            return;
        }
        
        container.innerHTML = profiles.map(profile => `
            <div class="profile-card ${profile.id === currentActiveProfileId ? 'active' : ''}">
                <div class="profile-header">
                    <h3>${profile.name}</h3>
                    ${profile.id === currentActiveProfileId ? '<span class="badge">Active</span>' : ''}
                </div>
                ${profile.start_date || profile.end_date ? `
                <div class="profile-dates">
                    ${profile.start_date ? `Start: ${formatDate(profile.start_date)}` : ''}
                    ${profile.end_date ? `${profile.start_date ? ' | ' : ''}End: ${formatDate(profile.end_date)}` : ''}
                </div>
                ` : ''}
                <div class="profile-actions">
                    ${profile.id !== currentActiveProfileId ? 
                        `<button class="btn btn-sm btn-primary" onclick="activateProfile(${profile.id})">Switch to This</button>` : 
                        '<button class="btn btn-sm" disabled>Current</button>'}
                    <button class="btn btn-sm btn-danger" onclick="deleteProfile(${profile.id})" 
                        ${profiles.length <= 1 ? 'disabled title="Cannot delete your only profile"' : ''}>
                        Delete
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function showCreateProfileModal() {
        document.getElementById('createProfileModal').style.display = 'flex';
    }
    
    function closeCreateProfileModal() {
        document.getElementById('createProfileModal').style.display = 'none';
        document.getElementById('profileName').value = '';
    }
    
    function createProfile() {
        const name = document.getElementById('profileName').value.trim();
        
        if (!name) {
            alert('Please enter a semester name');
            return;
        }
        
        fetch('/api/profiles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                closeCreateProfileModal();
                currentActiveProfileId = data.active_profile_id;
                displayProfiles(data.profiles);
                loadAllAnalytics(data.profiles);
            }
        });
    }
    
    function activateProfile(profileId) {
        fetch(`/api/profiles/${profileId}/activate`, {
            method: 'PUT'
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                currentActiveProfileId = data.active_profile_id;
                displayProfiles(data.profiles);
                loadDashboardData(); // Reload dashboard with new profile data
                alert('Profile switched! The dashboard now shows data from the selected semester.');
            }
        });
    }
    
    function deleteProfile(profileId) {
        if (!confirm('Are you sure you want to delete this profile? All associated data (classes, todos, study sessions) will be permanently deleted.')) {
            return;
        }
        
        fetch(`/api/profiles/${profileId}`, {
            method: 'DELETE'
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                currentActiveProfileId = data.active_profile_id;
                displayProfiles(data.profiles);
                loadAllAnalytics(data.profiles);
                loadDashboardData(); // Reload dashboard if active profile changed
            } else {
                alert(data.error || 'Failed to delete profile');
            }
        });
    }
    
    // Analytics Functions
    function loadAllAnalytics(profiles) {
        const container = document.getElementById('analytics-container');
        
        if (profiles.length === 0) {
            container.innerHTML = '<p class="empty-state">No profiles to analyze</p>';
            return;
        }
        
        container.innerHTML = '<p class="empty-state">Loading analytics...</p>';
        
        Promise.all(profiles.map(profile => 
            fetch(`/api/profiles/${profile.id}/analytics`).then(res => res.json())
        ))
        .then(results => {
            displayAnalytics(results, profiles);
        });
    }
    
    function displayAnalytics(analyticsData, profiles) {
        const container = document.getElementById('analytics-container');
        
        container.innerHTML = `
            <div class="analytics-grid">
                ${analyticsData.map((data, index) => {
                    const profile = profiles[index];
                    const analytics = data.analytics;
                    const isActive = profile.id === currentActiveProfileId;
                    
                    return `
                        <div class="analytics-card ${isActive ? 'active' : ''}">
                            <div class="analytics-header">
                                <h3>${profile.name}</h3>
                                ${isActive ? '<span class="badge">Current</span>' : ''}
                            </div>
                            <div class="analytics-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Subjects</span>
                                    <span class="stat-value">${analytics.subjects_count}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">GWA</span>
                                    <span class="stat-value">${analytics.gwa !== null && analytics.gwa !== undefined ? analytics.gwa.toFixed(2) : 'N/A'}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Todos Completed</span>
                                    <span class="stat-value">${analytics.completed_todos}/${analytics.todos_count}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Study Hours</span>
                                    <span class="stat-value">${analytics.total_study_hours}h</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function getThisWeekHours(sessions) {
        const now = new Date();
        const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
        weekStart.setHours(0, 0, 0, 0);

        return sessions
            .filter(s => new Date(s.date) >= weekStart)
            .reduce((sum, s) => sum + (parseFloat(s.hours) || 0), 0);
    }
</script>


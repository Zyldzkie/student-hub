<% @title = 'Dashboard' %>
<div class="page-header">
    <div>
        <h1>Dashboard</h1>
        <p class="subtitle">Welcome back! Here's your academic overview</p>
    </div>
</div>

<div class="dashboard-grid">
    <div class="dashboard-card">
        <h3>Overall GWA</h3>
        <p class="stat-value" id="overall-gwa">--</p>
        <p class="stat-label">Based on all subjects</p>
    </div>
    <div class="dashboard-card">
        <h3>Subjects</h3>
        <p class="stat-value" id="subjects-count">0</p>
        <p class="stat-label">Subjects this semester</p>
    </div>
    <div class="dashboard-card">
        <h3>Pending Tasks</h3>
        <p class="stat-value" id="pending-tasks">0</p>
        <p class="stat-label">Items in your to-do list</p>
    </div>
    <div class="dashboard-card">
        <h3>Study Time</h3>
        <p class="stat-value" id="study-hours">0</p>
        <p class="stat-label">Time logged this week</p>
    </div>
</div>

<div class="dashboard-sections-row">
    <div class="dashboard-section">
        <h2>Semester Profiles</h2>
        <p class="subtitle">Organize your academics by semester. You can use the Default profile or create specific semester profiles.</p>
        
        <div class="profile-controls">
            <button class="btn btn-primary" onclick="showCreateProfileModal()">
                <i class="fas fa-plus"></i> Create New Semester
            </button>
        </div>
        
        <div class="profiles-container" id="profiles-container">
            <p class="empty-state">Loading profiles...</p>
        </div>
    </div>

    <div class="dashboard-section">
        <h2>Recent Activity</h2>
        <div class="activity-list" id="activity-list">
            <p class="empty-state">No recent activity</p>
        </div>
    </div>
</div>

<!-- Create Profile Modal -->
<div id="createProfileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Semester Profile</h3>
            <button class="close-btn" onclick="closeCreateProfileModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="profileName">Semester Name *</label>
                <input type="text" id="profileName" placeholder="e.g., 4th year 2nd Sem - 2025" required>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCreateProfileModal()">Cancel</button>
            <button class="btn btn-primary" onclick="createProfile()">Create Profile</button>
        </div>
    </div>
</div>

<script>
    let currentActiveProfileId = null;

    // Load dashboard data
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
        loadProfiles();
        loadRecentActivity();
    });

    function loadRecentActivity() {
        fetch('/api/recent-activity')
            .then(res => res.json())
            .then(data => {
                displayRecentActivity(data.activities);
            })
            .catch(error => {
                console.error('Error loading recent activity:', error);
            });
    }

    function displayRecentActivity(activities) {
        const container = document.getElementById('activity-list');
        
        if (activities.length === 0) {
            container.innerHTML = '<p class="empty-state">No recent activity</p>';
            return;
        }
        
        container.innerHTML = activities.map(activity => {
            const date = new Date(activity.timestamp);
            const timeAgo = getTimeAgo(date);
            
            return `
                <div class="activity-item">
                    <i class="${activity.icon} activity-icon"></i>
                    <div class="activity-content">
                        <div class="activity-description">${escapeHtml(activity.description)}</div>
                        <div class="activity-time">${timeAgo}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins} ${diffMins === 1 ? 'minute' : 'minutes'} ago`;
        if (diffHours < 24) return `${diffHours} ${diffHours === 1 ? 'hour' : 'hours'} ago`;
        if (diffDays < 7) return `${diffDays} ${diffDays === 1 ? 'day' : 'days'} ago`;
        
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function loadDashboardData() {
        // Load GWA subjects
        fetch('/api/gwa-subjects')
            .then(res => res.json())
            .then(data => {
                document.getElementById('subjects-count').textContent = data.subjects.length;
                const gwaElement = document.getElementById('overall-gwa');
                if (data.gwa !== null && data.gwa !== undefined) {
                    gwaElement.textContent = data.gwa.toFixed(2);
                } else {
                    gwaElement.textContent = '--';
                }
            });

        // Load todos
        fetch('/api/todos')
            .then(res => res.json())
            .then(data => {
                const pending = data.todos.filter(t => !t.completed).length;
                document.getElementById('pending-tasks').textContent = pending;
            });

        // Load study sessions
        fetch('/api/study-sessions')
            .then(res => res.json())
            .then(data => {
                const thisWeek = getThisWeekHours(data.sessions);
                // Show hours with 2 decimal places for better precision
                // If less than 0.1 hours (6 minutes), show in minutes
                if (thisWeek < 0.1 && thisWeek > 0) {
                    const minutes = Math.round(thisWeek * 60);
                    document.getElementById('study-hours').textContent = `${minutes} min`;
                } else if (thisWeek === 0) {
                    document.getElementById('study-hours').textContent = '0';
                } else {
                    document.getElementById('study-hours').textContent = thisWeek.toFixed(2);
                }
            })
            .catch(error => {
                console.error('Error loading study sessions:', error);
                document.getElementById('study-hours').textContent = '0';
            });
        
        // Reload recent activity when dashboard data changes
        loadRecentActivity();
    }
    
    // Profile Management Functions
    function loadProfiles() {
        fetch('/api/profiles')
            .then(res => res.json())
            .then(data => {
                currentActiveProfileId = data.active_profile_id;
                // Load analytics for all profiles
                Promise.all(data.profiles.map(profile => 
                    fetch(`/api/profiles/${profile.id}/analytics`).then(res => res.json())
                ))
                .then(analyticsResults => {
                    displayProfiles(data.profiles, analyticsResults);
                });
            });
    }
    
    function displayProfiles(profiles, analyticsData = []) {
        const container = document.getElementById('profiles-container');
        
        if (profiles.length === 0) {
            container.innerHTML = '<p class="empty-state">No profiles yet. Create one to get started!</p>';
            return;
        }
        
        container.innerHTML = profiles.map((profile, index) => {
            const analytics = analyticsData[index]?.analytics || {
                subjects_count: 0,
                gwa: null,
                todos_count: 0,
                completed_todos: 0,
                total_study_hours: 0
            };
            const isActive = profile.id === currentActiveProfileId;
            
            return `
            <div class="profile-card ${isActive ? 'active' : ''}">
                <div class="profile-header">
                    <h3>${profile.name}</h3>
                    ${isActive ? '<span class="badge">Active</span>' : ''}
                </div>
                ${profile.start_date || profile.end_date ? `
                <div class="profile-dates">
                    ${profile.start_date ? `Start: ${formatDate(profile.start_date)}` : ''}
                    ${profile.end_date ? `${profile.start_date ? ' | ' : ''}End: ${formatDate(profile.end_date)}` : ''}
                </div>
                ` : ''}
                <div class="profile-analytics">
                    <div class="analytics-stats">
                        <div class="stat-item">
                            <span class="stat-label">Subjects</span>
                            <span class="stat-value">${analytics.subjects_count}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">GWA</span>
                            <span class="stat-value">${analytics.gwa !== null && analytics.gwa !== undefined ? analytics.gwa.toFixed(2) : 'N/A'}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Todos Completed</span>
                            <span class="stat-value">${analytics.completed_todos}/${analytics.todos_count}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Study Time</span>
                            <span class="stat-value">${analytics.total_study_hours}h</span>
                        </div>
                    </div>
                </div>
                <div class="profile-actions">
                    ${profile.id !== currentActiveProfileId ? 
                        `<button class="btn btn-sm" onclick="activateProfile(${profile.id})">Switch to This</button>` : 
                        '<button class="btn btn-sm" disabled>Current</button>'}
                    <button class="btn btn-sm btn-danger" onclick="deleteProfile(${profile.id})" 
                        ${profiles.length <= 1 ? 'disabled title="Cannot delete your only profile"' : ''}>
                        Delete
                    </button>
                </div>
            </div>
        `;
        }).join('');
    }
    
    function showCreateProfileModal() {
        document.getElementById('createProfileModal').style.display = 'flex';
    }
    
    function closeCreateProfileModal() {
        document.getElementById('createProfileModal').style.display = 'none';
        document.getElementById('profileName').value = '';
    }
    
    function createProfile() {
        const name = document.getElementById('profileName').value.trim();
        
        if (!name) {
            alert('Please enter a semester name');
            return;
        }
        
        fetch('/api/profiles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                closeCreateProfileModal();
                currentActiveProfileId = data.active_profile_id;
                // Load analytics for all profiles
                Promise.all(data.profiles.map(profile => 
                    fetch(`/api/profiles/${profile.id}/analytics`).then(res => res.json())
                ))
                .then(analyticsResults => {
                    displayProfiles(data.profiles, analyticsResults);
                });
            }
        });
    }
    
    function activateProfile(profileId) {
        fetch(`/api/profiles/${profileId}/activate`, {
            method: 'PUT'
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                currentActiveProfileId = data.active_profile_id;
                // Load analytics for all profiles
                Promise.all(data.profiles.map(profile => 
                    fetch(`/api/profiles/${profile.id}/analytics`).then(res => res.json())
                ))
                .then(analyticsResults => {
                    displayProfiles(data.profiles, analyticsResults);
                    loadDashboardData(); // Reload dashboard with new profile data
                    loadRecentActivity(); // Reload recent activity for new profile
                    alert('Profile switched! The dashboard now shows data from the selected semester.');
                });
            }
        });
    }
    
    function deleteProfile(profileId) {
        if (!confirm('Are you sure you want to delete this profile? All associated data (classes, todos, study sessions) will be permanently deleted.')) {
            return;
        }
        
        fetch(`/api/profiles/${profileId}`, {
            method: 'DELETE'
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                currentActiveProfileId = data.active_profile_id;
                // Load analytics for all profiles
                Promise.all(data.profiles.map(profile => 
                    fetch(`/api/profiles/${profile.id}/analytics`).then(res => res.json())
                ))
                .then(analyticsResults => {
                    displayProfiles(data.profiles, analyticsResults);
                    loadDashboardData(); // Reload dashboard if active profile changed
                });
            } else {
                alert(data.error || 'Failed to delete profile');
            }
        });
    }
    
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function getThisWeekHours(sessions) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const dayOfWeek = now.getDay();
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - dayOfWeek);
        weekStart.setHours(0, 0, 0, 0);

        return sessions
            .filter(s => {
                if (!s.date) return false;
                // Parse date string (YYYY-MM-DD format)
                const dateParts = s.date.split('-');
                if (dateParts.length !== 3) return false;
                const sessionDate = new Date(
                    parseInt(dateParts[0]), 
                    parseInt(dateParts[1]) - 1, 
                    parseInt(dateParts[2])
                );
                sessionDate.setHours(0, 0, 0, 0);
                return sessionDate >= weekStart;
            })
            .reduce((sum, s) => {
                const hours = parseFloat(s.hours) || 0;
                return sum + hours;
            }, 0);
    }
</script>


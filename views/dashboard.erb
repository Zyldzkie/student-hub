<% @title = 'Dashboard' %>
<div class="page-header">
    <div>
        <h1>Dashboard</h1>
        <p class="subtitle">Welcome back! Here's your academic overview</p>
    </div>
</div>

<div class="dashboard-grid">
    <div class="dashboard-card">
        <h3>Overall GPA</h3>
        <p class="stat-value" id="overall-gpa">--</p>
        <p class="stat-label">Based on all classes</p>
    </div>
    <div class="dashboard-card">
        <h3>Active Classes</h3>
        <p class="stat-value" id="active-classes">0</p>
        <p class="stat-label">Classes this semester</p>
    </div>
    <div class="dashboard-card">
        <h3>Pending Tasks</h3>
        <p class="stat-value" id="pending-tasks">0</p>
        <p class="stat-label">Items in your to-do list</p>
    </div>
    <div class="dashboard-card">
        <h3>Study Hours</h3>
        <p class="stat-value" id="study-hours">0</p>
        <p class="stat-label">Hours logged this week</p>
    </div>
</div>

<div class="dashboard-section">
    <h2>Recent Activity</h2>
    <div class="activity-list" id="activity-list">
        <p class="empty-state">No recent activity</p>
    </div>
</div>

<script>
    // Load dashboard data
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
    });

    function loadDashboardData() {
        // Load classes
        fetch('/api/classes')
            .then(res => res.json())
            .then(data => {
                document.getElementById('active-classes').textContent = data.classes.length;
                calculateOverallGPA(data.classes);
            });

        // Load todos
        fetch('/api/todos')
            .then(res => res.json())
            .then(data => {
                const pending = data.todos.filter(t => !t.completed).length;
                document.getElementById('pending-tasks').textContent = pending;
            });

        // Load study sessions
        fetch('/api/study-sessions')
            .then(res => res.json())
            .then(data => {
                const thisWeek = getThisWeekHours(data.sessions);
                document.getElementById('study-hours').textContent = thisWeek.toFixed(1);
            });
    }

    function calculateOverallGPA(classes) {
        if (classes.length === 0) {
            document.getElementById('overall-gpa').textContent = '--';
            return;
        }

        let totalWeight = 0;
        let weightedSum = 0;

        classes.forEach(cls => {
            if (cls.assignments && cls.assignments.length > 0) {
                const classGrade = calculateClassGrade(cls.assignments);
                const weight = 1; // Equal weight for all classes
                weightedSum += classGrade * weight;
                totalWeight += weight;
            }
        });

        if (totalWeight === 0) {
            document.getElementById('overall-gpa').textContent = '--';
            return;
        }

        const gpa = weightedSum / totalWeight;
        document.getElementById('overall-gpa').textContent = gpa.toFixed(1) + '%';
    }

    function calculateClassGrade(assignments) {
        let totalWeight = 0;
        let weightedSum = 0;

        assignments.forEach(assignment => {
            const weight = parseFloat(assignment.weight) || 0;
            const score = parseFloat(assignment.score) || 0;
            weightedSum += score * weight;
            totalWeight += weight;
        });

        return totalWeight > 0 ? weightedSum / totalWeight : 0;
    }

    function getThisWeekHours(sessions) {
        const now = new Date();
        const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
        weekStart.setHours(0, 0, 0, 0);

        return sessions
            .filter(s => new Date(s.date) >= weekStart)
            .reduce((sum, s) => sum + (parseFloat(s.hours) || 0), 0);
    }
</script>


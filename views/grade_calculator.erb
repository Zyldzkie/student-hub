<% @title = 'GWA Calculator' %>
<div class="page-header">
    <div>
        <h1>GWA Calculator</h1>
        <p class="subtitle">Calculate your General Weighted Average by adding subjects and their units</p>
    </div>
</div>

<div class="gwa-calculator-container">
    <div class="gwa-display-card">
        <h2>Your GWA</h2>
        <div class="gwa-value" id="gwa-value">--</div>
        <p class="gwa-label">Based on subjects with grades</p>
    </div>

    <div class="add-subject-section">
        <h3>Add Subject</h3>
        <form id="add-subject-form" class="subject-form" onsubmit="addSubject(event)">
            <div class="form-row">
                <div class="form-group">
                    <label for="subject-name">Subject Name</label>
                    <input type="text" id="subject-name" required placeholder="e.g., Mathematics, Science">
                </div>
                <div class="form-group">
                    <label for="subject-units">Units</label>
                    <input type="number" id="subject-units" required min="0" step="0.5" placeholder="3">
                </div>
                <div class="form-group">
                    <label for="subject-grade">Grade (Optional)</label>
                    <input type="number" id="subject-grade" min="0" max="100" step="0.01" placeholder="Leave blank if not graded">
                </div>
                <div class="form-group form-group-button">
                    <label>&nbsp;</label>
                    <button type="submit" class="btn btn-primary">Add Subject</button>
                </div>
            </div>
        </form>
    </div>

    <div class="subjects-history-section">
        <h3>Subject History</h3>
        <div class="subjects-list" id="subjects-list">
            <p class="empty-state">No subjects yet. Add your first subject above!</p>
        </div>
    </div>
</div>

<!-- Edit Subject Modal -->
<div id="editSubjectModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Subject</h3>
            <button class="close-btn" onclick="closeEditSubjectModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="edit-subject-form" onsubmit="saveEditedSubject(event)">
                <input type="hidden" id="edit-subject-id">
                <div class="form-group">
                    <label for="edit-subject-name">Subject Name *</label>
                    <input type="text" id="edit-subject-name" required placeholder="e.g., Mathematics, Science">
                </div>
                <div class="form-group">
                    <label for="edit-subject-units">Units *</label>
                    <input type="number" id="edit-subject-units" required min="0" step="0.5" placeholder="3">
                </div>
                <div class="form-group">
                    <label for="edit-subject-grade">Grade (Optional)</label>
                    <input type="number" id="edit-subject-grade" min="0" max="100" step="0.01" placeholder="Leave blank if not graded">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditSubjectModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadSubjects();
    });

    function loadSubjects() {
        fetch('/api/gwa-subjects')
            .then(res => res.json())
            .then(data => {
                displayGWA(data.gwa);
                displaySubjects(data.subjects);
            });
    }

    function displayGWA(gwa) {
        const gwaElement = document.getElementById('gwa-value');
        if (gwa !== null && gwa !== undefined) {
            gwaElement.textContent = gwa.toFixed(2);
        } else {
            gwaElement.textContent = '--';
        }
    }

    function displaySubjects(subjects) {
        const container = document.getElementById('subjects-list');
        
        if (subjects.length === 0) {
            container.innerHTML = '<p class="empty-state">No subjects yet. Add your first subject above!</p>';
            return;
        }

        container.innerHTML = subjects.map(subject => `
            <div class="subject-item">
                <div class="subject-info">
                    <div class="subject-name">${escapeHtml(subject.subject_name)}</div>
                    <div class="subject-details">
                        <span class="subject-units">${subject.units} units</span>
                        ${subject.grade ? `<span class="subject-grade">Grade: ${subject.grade.toFixed(2)}</span>` : '<span class="subject-grade no-grade">No grade yet</span>'}
                    </div>
                </div>
                <div class="subject-actions">
                    <button class="btn btn-sm btn-secondary" onclick="editSubject(${subject.id}, '${escapeHtml(subject.subject_name)}', ${subject.units}, ${subject.grade || 'null'})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteSubject(${subject.id})">Delete</button>
                </div>
            </div>
        `).join('');
    }

    function addSubject(event) {
        event.preventDefault();
        const subjectName = document.getElementById('subject-name').value.trim();
        const units = parseFloat(document.getElementById('subject-units').value);
        const grade = document.getElementById('subject-grade').value;

        fetch('/api/gwa-subjects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                subject_name: subjectName,
                units: units,
                grade: grade ? parseFloat(grade) : null
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('add-subject-form').reset();
                displayGWA(data.gwa);
                displaySubjects(data.subjects);
            }
        });
    }

    function editSubject(id, currentName, currentUnits, currentGrade) {
        // Populate the modal with current values
        document.getElementById('edit-subject-id').value = id;
        document.getElementById('edit-subject-name').value = currentName;
        document.getElementById('edit-subject-units').value = currentUnits;
        document.getElementById('edit-subject-grade').value = currentGrade || '';
        
        // Show the modal
        document.getElementById('editSubjectModal').style.display = 'flex';
    }

    function closeEditSubjectModal() {
        document.getElementById('editSubjectModal').style.display = 'none';
        document.getElementById('edit-subject-form').reset();
    }

    function saveEditedSubject(event) {
        event.preventDefault();
        
        const id = document.getElementById('edit-subject-id').value;
        const subjectName = document.getElementById('edit-subject-name').value.trim();
        const units = parseFloat(document.getElementById('edit-subject-units').value);
        const grade = document.getElementById('edit-subject-grade').value;

        fetch(`/api/gwa-subjects/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                subject_name: subjectName,
                units: units,
                grade: grade ? parseFloat(grade) : null
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                closeEditSubjectModal();
                displayGWA(data.gwa);
                displaySubjects(data.subjects);
            }
        });
    }

    function deleteSubject(id) {
        if (!confirm('Are you sure you want to delete this subject?')) {
            return;
        }

        fetch(`/api/gwa-subjects/${id}`, {
            method: 'DELETE'
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                displayGWA(data.gwa);
                displaySubjects(data.subjects);
            }
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
        const modal = document.getElementById('editSubjectModal');
        if (event.target == modal) {
            closeEditSubjectModal();
        }
    }
</script>

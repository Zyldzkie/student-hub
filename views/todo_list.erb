<% @title = 'To-Do List' %>
<div class="page-header">
    <div>
        <h1>To-Do List</h1>
        <p class="subtitle">Stay organized and track your tasks</p>
    </div>
    <button class="btn btn-primary" onclick="showAddTodoModal()">
        <span class="btn-icon">+</span>
        Add Task
    </button>
</div>

<div class="todo-container">
    <div class="todo-filters">
        <button class="filter-btn active" onclick="filterTodos('all')">All</button>
        <button class="filter-btn" onclick="filterTodos('active')">Active</button>
        <button class="filter-btn" onclick="filterTodos('completed')">Completed</button>
    </div>

    <div class="todos-list" id="todos-list">
        <p class="empty-state">No tasks yet. Click "Add Task" to get started!</p>
    </div>
</div>

<!-- Add Todo Modal -->
<div id="add-todo-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Task</h2>
            <button class="modal-close" onclick="closeAddTodoModal()">&times;</button>
        </div>
        <form id="add-todo-form" onsubmit="addTodo(event)">
            <div class="form-group">
                <label for="todo-title">Task Title</label>
                <input type="text" id="todo-title" required placeholder="e.g., Complete math homework">
            </div>
            <div class="form-group">
                <label for="todo-description">Description (optional)</label>
                <textarea id="todo-description" rows="3" placeholder="Add more details..."></textarea>
            </div>
            <div class="form-group">
                <label for="todo-due-date">Due Date (optional)</label>
                <input type="date" id="todo-due-date">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAddTodoModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Task</button>
            </div>
        </form>
    </div>
</div>

<script>
    let currentFilter = 'all';

    document.addEventListener('DOMContentLoaded', function() {
        loadTodos();
    });

    function loadTodos() {
        fetch('/api/todos')
            .then(res => res.json())
            .then(data => {
                renderTodos(data.todos);
            });
    }

    function renderTodos(todos) {
        const container = document.getElementById('todos-list');
        
        let filteredTodos = todos;
        if (currentFilter === 'active') {
            filteredTodos = todos.filter(t => !t.completed);
        } else if (currentFilter === 'completed') {
            filteredTodos = todos.filter(t => t.completed);
        }

        if (filteredTodos.length === 0) {
            container.innerHTML = '<p class="empty-state">No tasks found.</p>';
            return;
        }

        container.innerHTML = filteredTodos.map(todo => `
            <div class="todo-item ${todo.completed ? 'completed' : ''}">
                <input 
                    type="checkbox" 
                    class="todo-checkbox" 
                    ${todo.completed ? 'checked' : ''}
                    onchange="toggleTodo(${todo.id}, this.checked)"
                >
                <div class="todo-content">
                    <h4 class="todo-title">${escapeHtml(todo.title)}</h4>
                    ${todo.description ? `<p class="todo-description">${escapeHtml(todo.description)}</p>` : ''}
                    ${todo.due_date ? `<p class="todo-due-date">Due: ${formatDate(todo.due_date)}</p>` : ''}
                </div>
                <button class="icon-btn" onclick="deleteTodo(${todo.id})" title="Delete task">
                    üóëÔ∏è
                </button>
            </div>
        `).join('');
    }

    function filterTodos(filter) {
        currentFilter = filter;
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        loadTodos();
    }

    function showAddTodoModal() {
        document.getElementById('add-todo-modal').style.display = 'flex';
        document.getElementById('todo-title').focus();
    }

    function closeAddTodoModal() {
        document.getElementById('add-todo-modal').style.display = 'none';
        document.getElementById('add-todo-form').reset();
    }

    function addTodo(event) {
        event.preventDefault();
        const title = document.getElementById('todo-title').value;
        const description = document.getElementById('todo-description').value;
        const dueDate = document.getElementById('todo-due-date').value;

        fetch('/api/todos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                title, 
                description: description || null,
                due_date: dueDate || null
            })
        })
        .then(res => res.json())
        .then(data => {
            closeAddTodoModal();
            loadTodos();
        });
    }

    function toggleTodo(id, completed) {
        fetch(`/api/todos/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ completed })
        })
        .then(res => res.json())
        .then(data => {
            loadTodos();
        });
    }

    function deleteTodo(id) {
        if (confirm('Are you sure you want to delete this task?')) {
            fetch(`/api/todos/${id}`, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(data => {
                loadTodos();
            });
        }
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('add-todo-modal');
        if (event.target == modal) {
            closeAddTodoModal();
        }
    }
</script>

